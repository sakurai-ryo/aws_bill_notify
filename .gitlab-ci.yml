image: node:alpine

stages:
  - unitTest
  - build
  - deployDev
  - deployPro

Test:
  stage: unitTest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"' # pushされた場合
      when: always # 直前のステージでジョブの状態がどうであるかにかかわらずジョブを実行
  before_script:
    - npm i -D jest ts-jest @aws-cdk/assert @aws-cdk/core # テストに必要なモジュールのインストール
  script:
    - ls
    - echo "---- Unit Test ----"
    - npm run test # jest

Build:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"' #'$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"' masterへのcommitの場合 $CI_COMMIT_BRANCH
      when: always
    - if: "$VAR =~ /pattern/"
      when: manual
    - when: on_success
  cache:
    paths:
      - bundle/nodejs/node_modules # layerに使用するnode_modulesをキャッシュ
  script:
    - echo "---- Layer Install ----"
    - npx ts-node lib/process/setup.ts
    - echo "---- Build ----"
    - npm run build

# TODO: credentialの取得
DeployDev:
  stage: deployDev
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - if: "$VAR =~ /pattern/"
      when: manual
    - when: on_success
  cache:
    paths:
      - bundle/nodejs/node_modules
  script:
    - echo "---- Deploy ----"
    - SYSTEM_ENV=dev npm run deploy # 環境変数で環境を分岐させる

DeployPro:
  stage: deployPro
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: manual # 本番環境へのデプロイは手動実行にする
  cache:
    paths:
      - bundle/nodejs/node_modules
  script:
    - echo "---- Deploy ----"
    - SYSTEM_ENV=pro npm run deploy
